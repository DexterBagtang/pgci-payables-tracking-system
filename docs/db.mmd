erDiagram
    users {
        int id PK
        varchar name
        varchar username UK
        enum role "admin, purchasing, accounting"
        varchar email UK
        timestamp email_verified_at
        varchar password
        varchar remember_token
        datetime created_at
        datetime updated_at
    }

    vendors {
        int id PK
        varchar name
        varchar contact_person
        varchar email
        varchar phone
        text address
        enum category "SAP, Manual"
        varchar payment_terms
        boolean is_active
        enum vendor_type "supplier, contractor, service_provider, other"
        int created_by FK
        datetime created_at
        datetime updated_at
    }

    projects {
        int id PK
        varchar project_title
        varchar cer_number
        numeric total_project_cost
        numeric total_contract_cost
        enum project_status "active, on_hold, completed, cancelled"
        text description
        enum project_type "sm_project, philcom_project"
        varchar smpo_number "For SM Project type"
        enum philcom_category "profit_and_loss, capital_expenditure, others"
        varchar team
        int created_by FK
        datetime created_at
        datetime updated_at
    }

    purchase_orders {
        int id PK
        varchar po_number UK
        int project_id FK
        int vendor_id FK
        numeric po_amount
        numeric total_invoiced "Sum of all invoice amounts"
        numeric total_paid "Sum of net_amount from paid invoices"
        numeric outstanding_amount "po_amount - total_paid"
        datetime financials_updated_at "Last time financial summary was synced"
        enum currency "PHP, USD"
        enum po_status "draft, open, closed, cancelled"
        varchar payment_term
        date po_date
        date expected_delivery_date
        text description
        int created_by FK
        int finalized_by FK
        datetime finalized_at
        int closed_by FK
        datetime closed_at
        text closure_remarks
        datetime created_at
        datetime updated_at
    }

    po_line_items {
        int id PK
        int po_id FK
        varchar item_description
        numeric quantity
        numeric unit_price
        numeric total_amount "GENERATED"
        varchar unit_of_measure
        datetime created_at
        datetime updated_at
    }

    invoices {
        int id PK
        int purchase_order_id FK
        varchar si_number
        date si_date
        date si_received_at
        enum payment_type "cash, check, bank_transfer, credit_card, other"
        numeric invoice_amount
        enum currency "PHP, USD"
        numeric tax_amount
        numeric discount_amount
        numeric net_amount
        varchar terms_of_payment
        varchar other_payment_terms
        enum invoice_status "pending, received, in_progress, approved, pending_disbursement, rejected, paid, overdue"
        date due_date
        text notes
        date files_received_at
        date submitted_at
        varchar submitted_to
        int reviewed_by FK
        datetime reviewed_at
        datetime approved_at
        int created_by FK
        datetime created_at
        datetime updated_at
    }

    check_requisitions {
        int id PK
        varchar requisition_number UK
        enum requisition_status "draft, pending_approval, approved, rejected, processed, paid"
        numeric php_amount
        date request_date
        varchar payee_name
        text purpose
        varchar po_number
        varchar cer_number
        varchar si_number
        varchar account_charge
        varchar service_line_dist
        text amount_in_words
        varchar requested_by
        varchar reviewed_by
        varchar approved_by
        int generated_by FK
        datetime approved_at
        int processed_by FK
        datetime processed_at
        datetime created_at
        datetime updated_at
    }

    check_requisition_invoices {
        int id PK
        int check_requisition_id FK
        int invoice_id FK
        datetime created_at
        datetime updated_at
    }

    disbursements {
        int id PK
        varchar check_voucher_number UK
        date date_check_scheduled
        date date_check_released_to_vendor "Stops aging calculation"
        date date_check_printing
        text remarks
        int created_by FK
        datetime created_at
        datetime updated_at
    }

    check_requisition_disbursement {
        int id PK
        int check_requisition_id FK
        int disbursement_id FK
        datetime created_at
        datetime updated_at
    }

    remarks {
        int id PK
        varchar remarkable_type "Polymorphic type"
        int remarkable_id "Polymorphic ID"
        text remark_text
        int created_by FK
        datetime created_at
        datetime updated_at
    }

    files {
        int id PK
        varchar fileable_type "Polymorphic type"
        int fileable_id "Polymorphic ID"
        varchar file_name
        varchar file_path
        varchar file_type
        varchar file_category "document, image, spreadsheet, etc."
        varchar file_purpose "original_po, revised_po, invoice_copy, check_requisition, etc."
        int file_size "bytes"
        varchar disk "local, s3, etc."
        text description
        boolean is_active
        int version "File version number for tracking revisions"
        int uploaded_by FK
        datetime created_at
        datetime updated_at
    }

    activity_logs {
        int id PK
        varchar loggable_type "Polymorphic type"
        int loggable_id "Polymorphic ID"
        varchar action "created, updated, deleted, approved, etc."
        json changes "before/after values"
        int user_id FK
        varchar ip_address
        text notes
        datetime created_at
        datetime updated_at
    }

    audit_trails {
        int id PK
        varchar table_name
        int record_id
        enum action "create, update, delete"
        json changes "simplified: only what changed"
        int user_id FK
        datetime performed_at
        varchar ip_address
        text user_agent
    }

%% Core Relationships
    users ||--o{ vendors : "created_by"
    users ||--o{ projects : "created_by"
    users ||--o{ purchase_orders : "created_by"
    users ||--o{ purchase_orders : "finalized_by"
    users ||--o{ purchase_orders : "closed_by"
    users ||--o{ invoices : "created_by"
    users ||--o{ invoices : "reviewed_by"
    users ||--o{ check_requisitions : "generated_by"
    users ||--o{ check_requisitions : "processed_by"
    users ||--o{ disbursements : "created_by"
    users ||--o{ remarks : "created_by"
    users ||--o{ files : "uploaded_by"
    users ||--o{ activity_logs : "user_id"
    users ||--o{ audit_trails : "user_id"

    vendors ||--o{ purchase_orders : "has"
    projects ||--o{ purchase_orders : "has"
    purchase_orders ||--o{ po_line_items : "has"
    purchase_orders ||--o{ invoices : "has"

%% Junction Table Relationships
    check_requisitions ||--o{ check_requisition_invoices : "links_to"
    invoices ||--o{ check_requisition_invoices : "linked_by"
    
    check_requisitions ||--o{ check_requisition_disbursement : "links_to"
    disbursements ||--o{ check_requisition_disbursement : "linked_by"

%% Polymorphic Relationships - remarks
    remarks }o--o{ vendors : "remarkable"
    remarks }o--o{ projects : "remarkable"
    remarks }o--o{ purchase_orders : "remarkable"
    remarks }o--o{ invoices : "remarkable"
    remarks }o--o{ check_requisitions : "remarkable"
    remarks }o--o{ disbursements : "remarkable"

%% Polymorphic Relationships - files
    files }o--o{ users : "fileable"
    files }o--o{ vendors : "fileable"
    files }o--o{ projects : "fileable"
    files }o--o{ purchase_orders : "fileable"
    files }o--o{ invoices : "fileable"
    files }o--o{ check_requisitions : "fileable"
    files }o--o{ disbursements : "fileable"

%% Polymorphic Relationships - activity_logs
    activity_logs }o--o{ users : "loggable"
    activity_logs }o--o{ vendors : "loggable"
    activity_logs }o--o{ projects : "loggable"
    activity_logs }o--o{ purchase_orders : "loggable"
    activity_logs }o--o{ invoices : "loggable"
    activity_logs }o--o{ check_requisitions : "loggable"
    activity_logs }o--o{ disbursements : "loggable"
